<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mysite.restaurant.hj.mapper.UserMapper">

	<resultMap id="userMap" type="com.mysite.restaurant.hj.dto.UserDTO">
        <id property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="profileImageUrl" column="profile_image_url"/>
        <result property="notificationAgreed" column="notification_agreed"/>
        <result property="userType" column="user_type"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="status" column="status"/>
        <collection property="authorities" ofType="com.mysite.restaurant.hj.dto.UserAuthDTO">
            <id property="authNo" column="auth_no"/>
            <result property="auth" column="auth"/>
        </collection>
    </resultMap>

	<!-- 회원가입 -->
	<insert id="save" parameterType="com.mysite.restaurant.hj.dto.UserDTO" useGeneratedKeys="true" keyProperty="userId" keyColumn="user_id">
		INSERT INTO users (user_name, PASSWORD, NAME, email, phone, notification_agreed)
		VALUES (#{userName}, #{password}, #{name}, #{email}, #{phone}, #{notificationAgreed});
	</insert>
	
	<insert id="createAuth" parameterType="com.mysite.restaurant.hj.dto.UserAuthDTO">
		INSERT INTO user_auth (user_id, auth)
		VALUES (#{userId}, #{auth})
	</insert>
	
	<!-- 로그인 -->
	<select id="selectUserByUsername" resultMap="userMap">
		SELECT u.*, ua.auth_no, ua.auth
		FROM users u
		LEFT JOIN user_auth ua ON u.user_id = ua.user_id
		AND ua.is_deleted = FALSE
		WHERE u.user_name = #{userName}
		AND u.is_deleted = FALSE
		AND u.status = 'ACTIVE'
	</select>
	
	<select id="selectUserByUserId" resultMap="userMap">
		SELECT user_name, PASSWORD
		FROM users
		WHERE user_name = #{userName};
	</select>
	
	<update id="updateLastLogin">
		UPDATE users
		SET last_login_at = NOW()
		WHERE user_name = #{userName};
	</update>
	
	<!-- 사용자 정보 조회 -->
	<select id="selectUserProfile" resultType="com.mysite.restaurant.hj.dto.UserDTO">
		SELECT NAME, email, phone, notification_agreed
		FROM users
		WHERE user_id = #{userId};
	</select>
	
	<!-- 사용자 정보 수정 -->
	<update id="updateUserProfile">
		UPDATE users
		SET NAME = #{name}, phone = #{phone}, notification_agreed = #{notificationAgreed}
		WHERE user_name = #{userName};
	</update>
	
	<!-- 회원 탈퇴 -->	
	<!-- 참조 데이터 삭제 -->
	<delete id="deleteUserReference">
		DELETE FROM review_replies
		WHERE user_name = (SELECT user_id FROM users WHERE user_name = #{userName});
	</delete>
	<!-- 사용자 데이터 삭제 -->
	<delete id="deleteUser">
		DELETE FROM users
		WHERE user_name = #{userName};
	</delete>
</mapper>